<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <title>43-成果编辑器</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./static/css/font-awesome.css">
    <link rel="stylesheet" href="static/css/work.css"/>
    <script src="./static/js/jquery-2.1.3.min.js"></script>
    <script src="./data_a.js"></script>
</head>
<body>
<style>
    .pop1{margin: 100px auto 0 auto; width: 1030px; height: 505px; background: rgb(9, 164, 221); overflow: hidden;}
    .title_this{ text-align: left; text-indent: 20px; line-height: 50px; color: rgb(255, 255, 255); float: left; width: 100%; height: 50px; overflow: hidden; }
    .pop1_btn_close,.pop1_btn_min{ cursor: pointer; text-indent: 0; float: right; width: 25px; height: 25px; line-height: 25px; text-align: center; }
    .pop1_btn_close:hover{ background: rgb(255, 100, 100); }
    .pop1_btn_min:hover{ background: rgb(24, 119, 201); }
    .tab_title td{text-align: center;}
    .tab{ margin: 0 3px 3px 3px; padding: 10px; float: left; width: 1004px; height: 432px; overflow: hidden; background: rgb(255, 255, 255); }
    .t1{ float: left; width: 100%; border-color: rgb(237, 237, 237); }
    .drawBox{float: left; width: 100%; height: 390px; overflow: hiddne; overflow-y: auto;}
    .t1{border: 0;}
    .t1 tr td{border: 1px solid rgb(237, 237, 237);}
    .t{float: left; width: 100%; height: 390px; border: 0;margin-top: -1px;}
    .t tr td{border-right: 1px solid rgb(237, 237, 237);}
    .absBox{width: 1004px!important;;}
</style>

<div class="pop1">
    <div class="title_this">
        <div class="pop1_title_left">
            成果编辑器
            <div class="pop1_btn_close"><span class="fa fa-close"></span></div>
            <div class="pop1_btn_min"><span class="fa fa-minus"></span></div>
        </div>
    </div>
    <div class="tab">
        <table border="0" cellpadding="0" cellspacing="0" class="t1">
            <tr class="tab_title">
                <td width="20%" height="40px">输入相关</td>
                <td width="20%">模型相关</td>
                <td width="20%">计算相关</td>
                <td width="20%">出图相关</td>
                <td width="20%">校审相关</td>
            </tr>
        </table>
        <div class="drawBox">
            <div class="contentInfoBox">
                <div class="tmpLine"></div>
                <div class="absBox table">

                    <table class="t" border="0" cellpadding="0" cellspacing="0">
                        <tr>
                            <td width="20%"><div class="tmpLine"></div></td>
                            <td width="20%"></td>
                            <td width="20%"></td>
                            <td width="20%"></td>
                            <td width="20%"></td>
                        </tr>
                    </table>
                </div>
                <div class="absBox back"><div class="tmpLine"></div></div>
                <div class="absBox front"><div class="tmpLine"></div></div>

            </div>
        </div>
    </div>
</div>
<script>

// 绘图 --- 开始


var treeJumpTo = "#";

var elementsHeight = 33;
var elementsTopSpace = 10;
var width_12 = 148;
var width_34 = 116;
var btnSize = 17;
var childHeight = 35;
var initTop = 30;
var defaultEleTop = 20;
var endTop = 0;
var no1Key = true;

var distance_left = {
    class_0 : 10,
    class_1 : 140,
    class_2 : 230,
    class_3 : 440,
    class_4 : 650,
    class_5 : 840,
    class_child : 50
}

var getSize = function(id){ // 获得一个元素的位置和尺寸信息
    return {
        top : eval("("+id.css("top").replace("px","")+")"),
        left : eval("("+id.css("left").replace("px","")+")"),
        width : id.get(0).offsetWidth,
        height : id.get(0).offsetHeight
    }
}

var drawLinkLine_xie = function(id1,id2,myId){   // 绘制两个元素块之间的连接线
    var xiuzheng_left = 0;
    var xiuzheng_top = -1;
    var pos = {
        a : getSize(id1),
        b : getSize(id2)
    };
    var a = {
        y : pos.a.top + pos.a.height / 2,
        x : pos.a.left + pos.a.width
    };
    var b ={
        y : pos.b.top + pos.b.height / 2,
        x : pos.b.left
    };

    var fu = a.y > b.y? -1 : 1;

    var long = Math.sqrt( (a.x- b.x)*(a.x- b.x) + (a.y- b.y)*(a.y- b.y) );
    var tmp_height = Math.abs(a.y- b.y);
    var jiaodu = Math.asin(tmp_height/long)*360/(2*Math.PI) * fu;
    var tmp_left = (long / 2) - Math.cos(jiaodu*2*Math.PI/360) * long / 2;
    var tmp_top = Math.sin(jiaodu*2*Math.PI/360) * long / 2;

    var final_left = a.x - tmp_left + xiuzheng_left;
    var final_top = a.y + tmp_top + xiuzheng_top;

    var code = "<div id='"+myId+"' class='line line_xie' style='-ms-transform:rotate("+jiaodu+"deg);transform:rotate("+jiaodu+"deg);width:"+long+"px;top:"+ final_top +"px;left:"+ final_left +"px;'></div>";
    return code;
};
var drawLinkLine_heng = function(id1,id2,myId){ // 为两个元素之间绘制一条横线连接线
    var xiuzheng_top = -1;
    var xiuzheng_left = -1;
    var pos = {
        a : getSize(id1),
        b : getSize(id2)
    };
    var t = Math.abs(pos.a.top + pos.a.height/2 + xiuzheng_top);
    var l = Math.abs(pos.a.left + pos.a.width + xiuzheng_left);
    var w = Math.abs(pos.b.left - l);

    var code = "<div id='"+myId+"' class='line line_heng' style='width:"+w+"px;top:"+t+"px;left:"+l+"px;'></div>";
    return code;

};
var drawLinkLine_shu = function(id1,id2,myId){ // 为两个元素之间绘制一条竖线连接线
    var xiuzheng_left = -1;
    var pos = {
        a : getSize(id1),
        b : getSize(id2)
    };
    var l = pos.a.left + pos.a.width/2 + xiuzheng_left;
    var t = pos.a.top + pos.a.height;
    var h = Math.abs(pos.b.top - t);
    var code = "<div id='"+myId+"' class='line line_shu' style='height:"+h+"px;top:"+t+"px;left:"+l+"px;'></d   iv>";
    return code;
};
var drawLinkLine_zhe = function(id1,id2,myId){
    var xiuzheng_left = -1;
    var xiuzheng_top = -1;
    var pos = {
        a : getSize(id1),
        b : getSize(id2)
    };
    var l = pos.a.left + pos.a.width/2 + xiuzheng_left;
    var t = pos.a.top + pos.a.height + xiuzheng_top;
    var h = Math.abs(pos.b.top + pos.b.height/2 - t);
    var w = Math.abs(pos.b.left - l);
    var code = "<div id='"+myId+"' class='line line_zhe' style='width:"+w+"px;height:"+h+"px;top:"+t+"px;left:"+l+"px;'></div>";
    return code;
}
var linkElements = function(id1,id2,myId){
    var a = getSize(id1);
    var b = getSize(id2);
    var cha_top = Math.abs((a.top + a.height/2) - (b.top+ b.height/2));
    var cha_left = Math.abs( (a.left + a.width/2) - (b.left + b.width/2));
    if( cha_top<=5 && cha_left>5){    // 被定义为横线连接
        return drawLinkLine_heng(id1,id2,myId);
    }else if(cha_top>5 && cha_left>5){   // 被定义为斜线连接
        return drawLinkLine_xie(id1,id2,myId);
    }else if(cha_top>5 && cha_left<=5){ // 被定义为竖线连接
        return drawLinkLine_shu(id1,id2,myId);
    }
}
var checkMaxHeight = function(){
    var id = $(".front .del");
    var d = 0;
    var t = 0;
    for(var i= 0,imax=id.length;i<imax;i++){

        var tmp_top = id.eq(i).css("top").replace("px","");


        tmp_top = tmp_top=="auto"?"0":tmp_top;


        t = eval("("+tmp_top+")") + id.eq(i).height();
        d = d<t?t:d;
    }
//    console.log(tmp_top,id.eq(i-1))
    return d;
}
var checkDrawHeight = function(paddingBottom){
    var myPadding = 15;
    paddingBottom = (typeof(paddingBottom) == "number" ? paddingBottom : 0);
    var d = checkMaxHeight();
    var realHeight = d + paddingBottom + myPadding;
    $(".tmpLine").css({
        height : realHeight
    });
}
var addFront = function(code,callBack){
    $(".front .del").remove();
    $(".front").append(code);
    checkDrawHeight(50);
    callBack ? callBack() : false;
};
var addBack = function(code){
    $(".back .del").remove();
    $(".back").append(code);
}


var calcElementTop = function(){
    if(no1Key){
        defaultEleTop += initTop + elementsHeight + elementsTopSpace;
        no1Key = false;
    }else{
        defaultEleTop += elementsHeight + elementsTopSpace;
    }

    return defaultEleTop;
}


var getMiddleTop = function(d,childSum){
    if(childSum==undefined){childSum = 0}
    var res = 0;
    var n = d.length-1;
    if(n<=1 || childSum <= 1){
        res = d[0];
    }else{
        if(n%2==0){
            res = d[Math.floor(n/2-1)] + Math.abs(d[Math.floor(n/2)] - d[Math.floor(n/2-1)])/2;
        }else{
            res = d[Math.floor(n/2-1)] + Math.abs(d[Math.floor(n/2+1)] - d[Math.floor(n/2-1)])/2;
        }
    }
    return res;
}


var handlerClassTop = function(d){  // 重新计算元素距离顶端的距离
    if(d.length==1){
        d[1] = d[0];
    }else{
        if(d[d.length-1]!=d[d.lenght-2]){
            d[d.length] = d[d.lenght-1];
        }
    }
    return d;
}

var createMyTaskStream = function(d){
    var code = "";
    code += "<div class='elementsTitleBox' style='top:50px;'>任务启动日期<br>"+d[0].date+"</div>"+
    "<div class='circleBox1' style='left:125px;top:38px;'><div class='circleBox1Info'>开始</div></div>";
    for(var i= 1,imax= d.length-1;i<imax;i++){
        var class_1_top = [];
        var class_2_top = [];
        var class_3_top = [];
        var class_4_top = [];

        if(d[i].class_1.class_2!=undefined){
            for(var j= 0,jmax =d[i].class_1.class_2.length;j<jmax;j++ ){
                /*-------------------------------------------------------------------------------------------*/
                if(d[i].class_1.class_2[j].class_3!=undefined){
                    for(var k= 0,kmax=d[i].class_1.class_2[j].class_3.length;k<kmax;k++){
                        /*-------------------------------------------------------------------------------------------*/
                        if(d[i].class_1.class_2[j].class_3[k].class_4!=undefined){  // class4 层级元素位置


                            //class_4的元素在此开始添加
                            for(var l= 0,lmax=d[i].class_1.class_2[j].class_3[k].class_4.length;l<lmax;l++){
                                class_4_top[l] = calcElementTop();
                                var id_tmpp = "ele_"+i+"_"+j+"_"+k+"_"+l;
                                var myId = d[i].class_1.class_2[j].class_3[k].class_4[l].eleId ? d[i].class_1.class_2[j].class_3[k].class_4[l].eleId : "";
                                code += "<div data-myid='"+myId+"' id='"+id_tmpp+"' class='del elements elements_heard_"+boxType(d[i].class_1.class_2[j].class_3[k].class_4[l].tag)+"' style='top:"+(class_4_top[l])+"px;left:"+distance_left.class_5+"px;'>"+
                                "<div class='s1bcc class_45'>"+d[i].class_1.class_2[j].class_3[k].class_4[l].text+"</div>"+
                                "<div class='s1bce'></div>"+
                                "</div>";

                            }
                            class_3_top[k] = getMiddleTop(class_4_top,lmax);
                        }else{
                            class_3_top[k] = calcElementTop();
                        }

                        /*-------------------------------------------------------------------------------------------*/
                        var id_tmpp = "ele_"+i+"_"+j+"_"+k;
                        var myId = d[i].class_1.class_2[j].class_3[k].eleId ? d[i].class_1.class_2[j].class_3[k].eleId : "";
                        code += "<div data-myid='"+myId+"' id='"+id_tmpp+"' class='del elements elements_heard_"+boxType(d[i].class_1.class_2[j].class_3[k].tag)+"' style='top:"+(class_3_top[k])+"px;left:"+distance_left.class_4+"px;'>"+
                        "<div class='s1bcc class_45'>"+d[i].class_1.class_2[j].class_3[k].text+"</div>"+
                        "<div class='s1bce'></div>"+
                        "</div>";
                        //添加按钮 - 下级
                        var tmp_t = class_3_top[k]+ elementsHeight/2 -btnSize/2;
                        var tmp_l = distance_left.class_4+width_34 - btnSize/2;
                        code += "<div data-father='"+id_tmpp+"' data-type='add_childClass' class='"+id_tmpp+" chlidBtn btn_add btn_add_"+boxType(d[i].class_1.class_2[j].class_3[k].tag)+"' style='top:"+tmp_t+"px;left:"+tmp_l+"px;'></div>";


                    }
                    class_2_top[j] = getMiddleTop(class_3_top,kmax);
                }else{
                    class_2_top[j] = calcElementTop();
                }
                class_2_top = handlerClassTop(class_2_top);

                // CLASS_2 的创建
                var id_tmpp = "ele_"+i+"_"+j;
                var myId = d[i].class_1.class_2[j].eleId ? d[i].class_1.class_2[j].eleId : "";
                code += "<div data-myid='"+myId+"' id='"+id_tmpp+"' class='del elements elements_heard_"+boxType(d[i].class_1.class_2[j].tag)+"' style='top:"+(class_2_top[j])+"px;left:"+distance_left.class_3+"px;'>"+
                "<div class='s1bcc class_23'>"+d[i].class_1.class_2[j].text+"</div>"+
                "<div class='s1bce'></div>"+
                "</div>";

                //添加按钮 - 下级
                var tmp_t = class_2_top[j]+ elementsHeight/2 - btnSize/2;
                var tmp_l = distance_left.class_3  + width_12 - btnSize/2;
                code += "<div data-father='"+id_tmpp+"' data-type='add_childClass' class='"+id_tmpp+" chlidBtn btn_add btn_add_"+boxType(d[i].class_1.class_2[j].tag)+"' style='top:"+tmp_t+"px;left:"+tmp_l+"px;'></div>";
                class_1_top[i] = getMiddleTop(class_2_top,imax);
            }
            if(jmax==1){ class_1_top[i] = class_2_top[0]; }
        }else{

            class_1_top[i] = calcElementTop();
            defaultEleTop = defaultEleTop > class_1_top[class_1_top.length-1] ? defaultEleTop : class_1_top[class_1_top.length-1] + elementsTopSpace + elementsHeight;
        }

        class_1_top = handlerClassTop(class_1_top);
        var id_tmpp = "ele_"+i;
        var myId = d[i].class_1.eleId ? d[i].class_1.eleId : "";
        code += "<div class='elementsTitleBox' style='top:"+(class_1_top[i]+6)+"px;'>"+d[i].date+"</div>"+
        "<div data-myid='"+myId+"' id='"+id_tmpp+"' class='del elements elements_heard_"+boxType(d[i].class_1.tag)+"' style='top:"+(class_1_top[i])+"px;left:"+distance_left.class_2+"px;'>"+
        "<div class='s1bcc class_23'>"+d[i].class_1.text+"</div>"+
        "<div class='s1bce'></div>"+
        "</div>";

        //添加按钮 - 下级
        var tmp_t = class_1_top[i]+ elementsHeight/2 - btnSize/2;
        var tmp_l = distance_left.class_2 + width_12 - btnSize/2;
        code += "<div data-father='"+id_tmpp+"' data-type='add_childClass' class='"+id_tmpp+" chlidBtn btn_add btn_add_"+boxType(d[i].class_1.tag)+"' style='top:"+tmp_t+"px;left:"+tmp_l+"px;'></div>";

        code += "<div id='ele_0_"+i+"' class='del circleBox_"+(TagType(d[i].tag))+"' style='top:"+(class_1_top[i])+"px;left:"+distance_left.class_1+"px;'></div>";
    }

    var endTop = calcElementTop();

    code += "<div class='elementsTitleBox' style='top:"+endTop+"px;'>任务启动日期<br>"+d[d.length-1].date+"</div>"+
    "<div class='circleBox2' style='left:128px;top:"+(endTop-12)+"px;'><div class='circleBox2Info'>结束</div></div>";

    addFront(
            code,
            function(){
                drawAllLine(d);
            }
    );
}

var drawAllLine = function(d){
    for(var i= 1,imax= d.length-1;i<imax;i++){
        if(i==1){
            addBack(linkElements($(".circleBox1"),$("#ele_0_"+i),""));
        }else{
            addBack(linkElements($("#ele_0_"+(i-1)),$("#ele_0_"+i),""));
        }
        addBack(linkElements($("#ele_0_"+i),$("#ele_"+i),"line_0_1_"+i));
        if(d[i].class_1.class_2!=undefined){
            for(var j= 0,jmax =d[i].class_1.class_2.length;j<jmax;j++ ){
                addBack(linkElements($("#ele_"+i),$("#ele_"+i+"_"+j),"line_1_2_"+j));
                if(d[i].class_1.class_2[j].child!=undefined){
                    addBack(drawLinkLine_zhe($("#ele_"+i+"_"+j),$("#child_"+i+"_"+j),"zhe_1_2_"+j));
                }
                if(d[i].class_1.class_2[j].class_3!=undefined){
                    for(var k= 0,kmax=d[i].class_1.class_2[j].class_3.length;k<kmax;k++){
                        addBack(linkElements($("#ele_"+i+"_"+j),$("#ele_"+i+"_"+j+"_"+k),"line_1_2_"+j));
                        if(d[i].class_1.class_2[j].class_3[k].child!=undefined){
                            addBack(drawLinkLine_zhe($("#ele_"+i+"_"+j+"_"+k),$("#child_"+i+"_"+j+"_"+k),"zhe_1_2_"+j));
                        }
                        if(d[i].class_1.class_2[j].class_3[k].class_4!=undefined){
                            for(var l= 0,lmax=d[i].class_1.class_2[j].class_3[k].class_4.length;l<lmax;l++){
                                addBack(linkElements($("#ele_"+i+"_"+j+"_"+k),$("#ele_"+i+"_"+j+"_"+k+"_"+l),"line_1_2_"+j));
                                if(d[i].class_1.class_2[j].class_3[k].class_4[l].child!=undefined){
                                    addBack(drawLinkLine_zhe($("#ele_"+i+"_"+j+"_"+k+"_"+l),$("#child_"+i+"_"+j+"_"+k+"_"+l),"zhe_1_2_"+j));
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    addBack(linkElements($("#ele_0_"+ (d.length-2)),$(".circleBox2")));
}

var boxType = function(tag){
    var res = "red";
    switch(tag){// 1->灰色框,2->红色框,3->绿色框,4->蓝色框
        case 1:
            res = "gray";
            break;
        case 2:
            res = "red";
            break;
        case 3:
            res = "green";
            break;
        case 4:
            res = "blue";
            break;
        default :
            res = "red";
    }
    return res;
}

var TagType = function(tag){
    var res = "ok";
    switch(tag){    // 1->对勾,2->惊叹号,3->今天,0->差,4->时钟
        case 1:
            res = "ok";
            break;
        case 2:
            res = "tanhao";
            break;
        case 3:
            res = "now";
            break;
        case 4:
            res = "clock";
            break;
        default :
            res = "ok";
    }
    return res;
}

var setWidth = function(){
    var w = $(".taskInfoBox").width();
    $(".absBox").css({width : w})
}

// 绘图 -- 结束


createMyTaskStream(tmp_data);
</script>
</body>

</html>